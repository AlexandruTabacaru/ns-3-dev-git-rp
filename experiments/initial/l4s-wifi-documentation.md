# ns-3 L4S Wi-Fi initial experiment documentation

## 1. Introduction

This experiment uses a Python script (**run-l4s-wifi.py**) to launch one simulation execution of
the **l4s-wifi.cc** ns-3 C++ simulation program, and to plot some initial time-series results.

The program makes use of a slightly extended version of the ns-3.40 public release:  1) a
model for TCP Prague has been added, 2) a DualPi2 coupled AQM has been added, and 3) the
ns-3 Wi-Fi model has been slightly extended to provide some flow control between the overlying
DualPi2 model and the underlying device queue.

The C++ program itself is found at **scratch/l4s-wifi.cc** as referenced from the top-level ns-3
directory.  There is no requirement to run this program from this experiment directory using
the Python script-- the C++ program can be run from the command-line like other ns-3 programs,
such as:

~~~
./ns3 run l4s-wifi
~~~

This experiment directory provides a Python runner and plotting script to facilitate
experiment control.  Instead, the way to run the experiment from this directory is to
configure the parameters in **run-l4s-wifi.py** as appropriate, and then to run it:

~~~
./run-l4s-wifi.py
~~~

and then to recurse into the **results** directory that is created by the Python program
and work with the simulation output stored there.

This guide assumes that you have downloaded/cloned this version of ns-3 from CableLabs
and have built it in the usual way; see the [ns-3 Quick Start](https://www.nsnam.org/docs/tutorial/html/quick-start.html) for more information if needed.

We will first describe the C++ scenario program, and then cover the Python program,
and finally describe the output generated by the Python program.

## 2. Simulation overview

###2.1 Simulation Topology

The following figure (taken from l4s-wifi.cc) represents the topology.

~~~
// Node  0                     Node 1                           Nodes 2+
//
// server ---------------------> AP --------------------------> STA * N clients
//         1 Gbps
//         20 ms base RTT            BW 20/80/160 MHz            # N/2 for L4S flows
//                                   Fixed MCS                   # N/2 for classic flows
//
~~~

**Figure 1: l4s-wifi.cc topology**

The server is connected to the AP by a 1 Gbps point-to-point link with a configurable base
RTT (10 ms one-way, 20 ms round trip, by default).  The AP can talk to multiple STAs.  There
is a primary (foreground) STA and possibly additional background STAs.  The Wi-Fi link
is an ns-3 default 802.11ax configuration (80 MHz channel, one spatial stream) in 5 GHz
and with a fixed MCS (default MCS 2). A-MPDU is configured, but A-MSDU is not by default
(although it can be enabled).  A LogDistance propagation loss model is used, but the nodes
are close enough that no propagation losses occur.  RTS/CTS protection is disabled but can
be enabled if desired.

###2.2 Traffic

The foreground traffic consists of two TCP flows by default (one Cubic and one Prague),
although this is configurable.  It is possible to add more background Cubic flows to
different STAs.  Note that the ns-3 Wi-Fi AP queue does not implement per-STA queues for
DCF (for airtime fairness).  For this reason, the background flows are launched in the
opposite direction (from STAs to server) so that they independently contend for channel
access.

The Prague TCP flow(s) are started at simulation time 1s.  The foreground Cubic flows
are started at time 1.05s.  The background flows (if any) are started at time 1.1s.
Each flow is a bulk file transfer with a configurable number of bytes (10 MB by default).

The simulation is configured, by default, to run until one second has elapsed since the
last TCP flow has completed.  This stopping time can be overridden at the command line.

###2.3 Output files

The program output consists of many time-series data files, and PCAP traces for dumps a lot of output:

* PCAP files, traced from:
    * the server (node 0, interface 0: **l4s-wifi-0-0.pcap**)
    * WAN interface on the AP (node 1, interface 0: **l4s-wifi-1-0.pcap**)
    * the Wi-Fi interface on the AP (node 1, interface 1: **l4s-wifi-1-1.pcap**)
    * the STA Wi-Fi interface (**l4s-wifi-2-0.pcap**)

* Several time-series traces from the AP Wi-Fi device:
    * **wifi-dequeue-events.dat**: Each packet departing from the AP Wi-Fi queue is traced.  The second column is the packet size in bytes counting the IP packet size plus 8 bytes of LLC header (e.g., typically 1508 bytes).  This trace is limited to QOSDATA packets (i.e. not control or management frames).
    * **wifi-dequeue-throughput.dat**: The throughput of the above dequeue trace is calculated on 100 ms intervals, and exported as a time series.
    * **wifi-queue-bytes.dat**:  Each time the size of the device queue (WifiMacQueue) changes, the new size (in bytes) is written.  Note that a total of 38 bytes per IP packet is added to the queued packets, for the Wi-Fi and LLC overhead (e.g., typically 1538 bytes for a 1500 byte IP packet).  This trace includes control and management frames.
    * **wifi-dualpi2-bytes.dat**:  Each time the size of the overlying DualPi2QueueDisc changes, the new size (in bytes) is written.  This aggregates both the L and C queues.  The packet size is the IP packet size (e.g., typically 1500 bytes).
    * **wifi-dualpi2-l-sojourn.dat**: Sojourn time of L packets in the DualPi2QueueDisc (time from DualPi2 enqueue until the packet is dequeued into the WifiNetDevice).
    * **wifi-dualpi2-C-sojourn.dat**: Sojourn time of C packets in the DualPi2QueueDisc.

* Several time-series traces from the first foreground TCP Prague flow (note:  if there are N foreground flows, only the first is traced in these files):
    * **prague-throughput.dat**:  100 ms average of TCP throughput (just payload bytes, not counting headers)
    * **prague-cwnd.dat**:  Congestion window (maintained in units of bytes)
    * **prague-ssthresh.dat**:  Slow start threshold (maintained in units of bytes)
    * **prague-pacing-rate.dat**:  The current pacing rate (bits per second)
    * **prague-send-interval.dat**:  The time interval since the last segment was sent
    * **prague-cong-state.dat**:  The congestion state machine
    * **prague-ecn-state.dat**:  The ECN state machine
    * **prague-rtt.dat**:  Each TCP RTT sample

Files prefixed with 'cubic' are similar to the above Prague files (i.e., tracing the first foreground Cubicl flow).

###2.4 Command line arguments

In ns-3, it is common to expose frequently changed parameters through the command-line
arguments system.  Most ns-3 attribute values can be configured through this system without
any special handling code, but we also expose some explicit arguments for convenience.

To see these options, run the following command:

~~~
./ns3 run l4s-wifi -- --PrintHelp
~~~

Note the double dash-- this tells the shell that the arguments that follow belong to the ns-3
program and not to the **ns3** script.  The following syntax using quotations works the same:

~~~
./ns3 run 'l4s-wifi --PrintHelp'
~~~

In either case, the output will be:
~~~
 [Program Options] [General Arguments]

The l4s-wifi program experiments with TCP flows over L4S Wi-Fi configuration

Program Options:
    --numCubic:         Number of foreground Cubic flows [1]
    --numPrague:        Number of foreground Prague flows [1]
    --numBackground:    Number of background flows [0]
    --numBytes:         Number of bytes for each TCP transfer [10000000]
    --duration:         (optional) scheduled end of simulation [+0fs]
    --wanLinkDelay:     one-way base delay from server to AP [+10ms]
    --mcs:              Index (0-11) of 11ax HE MCS [2]
    --channelWidth:     Width (MHz) of channel [80]
    --spatialStreams:   Number of spatial streams [1]
    --flowControl:      Whether to enable flow control (set also the limit) [true]
    --limit:            Queue limit (bytes) [65535]
    --scale:            Scaling factor for queue limit [1]
    --rtsCtsThreshold:  RTS/CTS threshold (bytes) [0]
    --processingDelay:  Notional packet processing delay [+10us]
    --showProgress:     Show simulation progress every 5s [false]

General Arguments:
    --PrintGlobals:              Print the list of globals.
    --PrintGroups:               Print the list of groups.
    --PrintGroup=[group]:        Print all TypeIds of group.
    --PrintTypeIds:              Print all TypeIds.
    --PrintAttributes=[typeid]:  Print all attributes of typeid.
    --PrintVersion:              Print the ns-3 version.
    --PrintHelp:                 Print this help message.
~~~

The **Program Options** are the ones customized for this program.  The **General Arguments**
are available automatically through the command-line system.  The default values are
printed in brackets at the end of the string.

Some notes on a few of these parameters:

* **numBytes**: This configures the file size, in bytes, for each TCP flow.  By default, it is 50 MB but depending on the configuration and number of flows active, this parameter is likely going to need to be adjusted to suit the scenario.
* **limit**: This is the size of the so-called "aggregation buffer" (or device buffer).  The default of 65535 corresponds to the maximum A-MPDU size in bytes (recall, we do not have A-MSDU configured, so this is the maximal amount of data that can be sent in one TXOP, and it works out to 42 full-sized TCP segments).
* **scale**:  This is a scaling factor of how much larger the aggregation buffer should be scaled.  A factor of 2, for instance, will double the size from whatever is specified as the limit.
* **rtsCtsThreshold**:  This argument exposes the WifiRemoteStationManager RtsCtsThreshold attribute; (A-)MPDUs larger (in bytes) than this threshold require an RTS/CTS exchange.  If this argument is zero, the normal attribute default applies, which disables RTS/CTS.  A low non-zero value such as 500 or 1000 should enable RTS/CTS for all (A-)MPDUs.
* **processingDelay**:  This is the newly-added model of processing delay from the time that a packet arrives to be enqueued before it is available for actual transmission.  By default, it is 10 us;
other values haven't been tested much.
* **mcs**: Values between 0 and 11 are possible.  However, note that with this configuration, only MCS 0-2 will occupy the full AC_BE TXOP duration of 5.484 ms.  At higher MCS, the A-MPDU will take less than 5 ms to transmit.
* **channelWidth**: Values of 20 (MHz), 40, 80, and 160 are allowed; default is 80.
* **spatialStreams**: Number of spatial streams; default is 1.
* **duration**:  Use this optional parameter to force the simulator to stop at a specific time.  By default, it will run until 1 second after the last TCP flow completed.
* **flowControl**: This enables or disables the flow control coordination between the queues.  It is recommended not to change this (perhaps it will be removed in future versions)

## 3. Experiment overview

The Python program in **experiments/initial** is a wrapper around **l4s-wifi.cc**.  It passes
arguments to the program and manages the execution and output.  It takes the following steps:

1\. It creates a timestamped results directory, with the naming convention of **results-YYYYMMDD-hhmmss**

2\. It copies itself, **l4s-wifi.cc**, and the plotting program **plot-l4s-wifi.py** into the directory

3\. It creates a file **version.out** that lists the version of ns-3 (from git history).  An example is below:

~~~
# Branch name                    commit hash                   commit message
* l4s-wifi 3c0e8b85b [origin/l4s-wifi: ahead 12] Change default file size to 50 MB%
~~~

The above says that the code ran on the l4s-wifi branch at commit 3c0e8b85b.  The branch is
frum the upstream l4s-wifi branch on GitLab, but it is ahead of that upstream branch by 12
commits.  The commit message for commit 3c0e8b85b is shown.

In addition, if there is any modification to the source files of the above version, the diff
file is stored in **version.diff**

4\.  The script will try to build ns-3.  If the build fails, the program exits.  The output of the build is captured in **build.out**

5\.  The script will run **l4s-wifi** with the provided arguments (which are passed as command-line arguments):

~~~
numCubic = 1
numPrague = 1
numBackground = 0
numBytes = 100000000
duration = 30
# wanLinkDelay is 1/2 of the desired base RTT
wanLinkDelay = "10ms"
mcs = 2
channelWidth=80
spatialStreams=1
flowControl = 1
limit = 65535
scale = 1
# Set rtsCtsThreshold to a low value such as 1000 (bytes) to enable RTS/CTS
# Zero disables the explicit setting of the WifiRemoteStationManager attribute
rtsCtsThreshold = 0
showProgress = 0
~~~

The output of the run will be stored in **run.out**.  In addition, the command string used
to invoke the C++ program is stored in **commandlog.out**; this command can be copy-pasted
to a terminal to re-run the ns-3 program in the same way as the Python program (for debugging).

6\.  The plotting program **plot-l4s-wifi.py** is run, to generate a single page of five time series plots.

The plot is stored in a file **l4s-wifi.pdf**.  The title of the plot is generated by the
'plotTitle' string built at the beginning of the **run-l4s-wifi.py** program.


The above is just a starting point that can be tailored for actual experiments.

